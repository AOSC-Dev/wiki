+++
title = "AOSC OS 主题制维护指南"
description = "AOSC OS 软件包维护的一般流程规范"
date = 2020-05-04T03:35:53.850Z
[taxonomies]
tags = ["dev-sys"]
+++

# 简介

自 2020 年秋季起，AOSC OS 停止使用以季度为单位的迭代周期，转为基于“主题”的新迭代计划。这里的“主题”指一次或多次针对某些软件包进行更新、重构或变更的“独立流程”。

## 变更原因

此调整是为了应对维护者在跟进固定迭代周期时日益增长的压力，以及现有模式存在的各种不足。例如，虽然 2020 年春季的迭代周期按时完成，但这是以减少工作量（直白来说，就是成果缩水）为代价的。此外，新软件包必须按照固定周期依次经过 `testing-proposed`、`testing`，最终进入`stable`，整个流程至少需要三个月才能到达 `stable` 用户手中。

再者，在现行的[例外机制](/developer/packaging/cycle-exceptions/)下，更新的测试并不充分，因为依赖于这些例外的软件包也可以在相同的例外条件下被更新。

## 图示对比

基于主题的迭代方式废除了旧版 [AOSC OS 维护指南](/developer/packaging/maintenance-guidelines/) 中所描述的六分支架构，转而将每一次更新（例如 GNU Nano 5.4）或一批更新（例如 KDE Applications 20.08）视作一个“主题”，并为每个主题维护独立的构建—测试—发布流程。

例如，将 KDE Applications 从 20.04 升级到 20.08，在旧的迭代周期中流程如下：

| 流程阶段 | 工作内容                                                                              | 时间周期                      |
|-----------|---------------------------------------------------------------------------------- |---------------------------------|
| 调研    | 维护者发现 KDE Applications 20.08 更新，阅读更新日志和发布公告  | 非冻结期（约 2 个月） |
| 打包 | 维护者为 KDE Applications 20.08 打包，并将变更提交至 `testing-proposed` | 非冻结期（约 2 个月） |
| 测试   | 维护者将软件包推送到测试仓库进行验证                               | 直至迭代周期结束（约 3 个月）  |
| 发布  | 维护者合并分支，并将软件包移至 `stable` 以供正式使用    | 迭代周期结束（约 3 个月）        |

在新机制下，不再采用固定三个月（甚至更长）的迭代周期，也不会将 KDE Applications 20.08 与其他软件包更新混合在一起，而是按以下流程执行（假设时间需求如下）：

| 流程阶段    | 工作内容                                                                                                                                                          | 时间周期                       |
|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
| 调研       | 维护者发现 KDE Applications 20.08 更新，阅读更新日志和发布公告                                                                              | 发现更新当天（第 1 天）  |
| 讨论   | 维护者与其他维护者讨论该更新的适用性                                                                                   | 达成共识当天（第 3 天） |
| 打包    | 维护者创建主题分支 `kde-applications-20.08` 并完成更新打包                                                                               | 构建完成当天（第 7 天）  |
| 测试      | 维护者将 KDE Applications 20.08 推送至 `kde-applications-20.08` 测试仓库                                                                             | 构建完成当天（第 7 天）  |
| 通知 | 维护者通知其他维护者和用户该测试仓库的存在，并发起 Pull Request 以供审核                                                         | 直至获批（第 14 天） |
| 发布     | 维护者将 `kde-applications-20.08` 合并至 `stable`，对所有软件包进行重构并与 `stable` 重新构建, 将重构后的软件包上传至 `stable` 以供正式使用 | 第二次构建完成当天（第 16 天） |

由此可见，KDE Applications 20.08 可以按照自身的时间需求完成调研、讨论、打包、测试和发布。
由于 KDE Applications（理应）有较多用户，测试周期可以相对较短，从而大幅缩短旧模式下长达三个月的滞后期。

该流程将在后续章节中详细说明。

# 定义、规则与流程

本节用于说明维护者需遵循的概念定义、规则和操作流程。

## 定义

“主题”（Topic）是指针对一个或多个软件包进行更新、重构或修改的行为。
在每个主题中，仅包含受影响的最小必要软件包集合。
每个主题都是一个自包含（并且\[独立于其他主题\]）的周期，包含调研、讨论、打包、测试、通知和发布等环节。

## 规则

1. 主题应尽可能具体，仅包含确实需要更新、重构或修改的软件包。
    - 唯一的例外情况是当多个软件包“天然属于同一类”或“可合理打包在一起”时。一般来说，桌面环境（如 GNOME 3.38、Plasma 5.20）的一系列更新、功能相似的软件包（如各类 RIME 数据包）、或更新会触发其他软件包重构的情况（如 Boost 1.73），都属于此例外。
2. 主题一旦完成，不得重复使用。
3. 主题之间不得产生冲突，也不得以需要 rebase 的方式相互影响。
    - 创建主题前，维护者应在日常交流或每周会议中与他人讨论，提前发现潜在的主题冲突。
    - 一旦发现潜在冲突，维护者应相互协调，必要时推迟一个或多个主题的执行。
    - 若意外产生冲突，维护者应制定计划，将一个分支 rebase 到另一个分支上。
4. 主题命名格式为 `$PKGNAME-$PKGVER`
   （例如 `nano-5.4`），仓库分支名称与主题名称保持一致（如 
   `nano-5.4`）。
    - 非更新类主题应以用途命名，格式为 `$PKGNAME-$PKGVER-$PURPOSE`（例如 `gnome-shell-3.38.1-build-fix`、`gnome-shell-3.38.1-ppc64el-adaptation`；若是引入新软件包，则使用 `gnome-shell-ng-4.0-new`）。
    - 多软件包主题应以“主软件包”及其通用版本命名，例如 `gnome-3.38`、`boost-1.73`。
    - 多软件包且版本不一致的主题，应使用主软件包名称，后接 `-survey` 及调研日期，例如 `rime-data-survey-20200928`。
5. 构建主题中的软件包时，每个软件包都必须使用全新的构建环境。 这意味着在构建下一个软件包前，必须将环境回滚至最初的 BuildKit。
    - 此规则无任何例外。
6. 提交 Pull Request 进行审核。
   维护者需测试受影响的软件包，并通过已安装在 AOSC OS 系统中的主题管理工具通知用户。
    - 测试完成后，合并 Pull Request。
    - 创建标签，并删除工作分支。
    - 在稳定环境中重新构建所有受影响的软件包，然后上传到 `stable` 仓库。旧的临时构建应归档保存。
7. 测试周期没有固定期限，但当每个架构上的软件包都通过测试后，即可批准并将主题标记为“完成”。
    - 若测试周期长期停滞，可视为该软件包已无法维护，应直接移除。
    - 严禁因为测试周期过长而强行合并。

## 主题迭代流程

基于主题的迭代流程一般包括以下步骤：

- 调研：维护者收到通知或自行发现，有一个或多个软件包需要更新或进行修改。
- 讨论：维护者需与他人确认，确保不存在跨主题的冲突，即某一主题中的软件包修改不会阻碍另一主题的工作。
    - 例如，在更新 Boost 版本时，所有依赖 Boost 的反向依赖包通常都需要重新构建。此时，除负责 Boost 主题的维护者外，其他维护者需检查自己负责的软件包是否在 Boost 更新所需的重构列表中。若在列表中，则应延迟该非 Boost 主题的工作；若不在，则可照常进行。
- 打包：维护者创建对应的主题。
    - 将构建完成的软件包上传至该主题对应的仓库。
- 审查：维护者必须创建 Pull Request，供其他维护者审查其构建脚本。
    - 当脚本层面的更改获得批准后，另一位维护者可在 Pull Request 上添加 `lgtm` 标签，表示该构建脚本符合 [软件包样式指南](https://wiki.aosc.io/developer/packaging/package-styling-manual/).
- 测试：维护者和用户可使用 [AOSC OS Topic Manager](https://github.com/AOSC-Dev/atm/)
  加入主题测试。
    - 一旦来自用户/维护者的反馈表明更新运行正常、质量符合预期，另一位维护者可再次审查该 Pull Request 并将其标记为已批准。
    - 此后，维护者需构建受影响的软件包并将其上传到 `stable` 仓库。
- 发布：在维护者将 Pull Request 标记为“已批准”后，主题维护者可合并该 Pull Request，并将更新上传至 `stable` 仓库。
    - 在此阶段，维护者必须在干净的 `stable` 环境中重新构建该主题中所有受影响的软件包，然后再上传。

## Stable 分支保护

`stable` 分支受保护，不允许直接提交代码。所有提交必须严格按照前文所述的规则和流程合并到该分支。

# 特殊主题与例外情况

有些主题需要进一步说明，或在执行流程上存在例外。本节将对此类情况进行说明。

## 发行候选内核

按照惯例，AOSC OS 会打包发行候选版本的内核，以便维护者提前进行配置和补丁适配。然而，这类维护过程通常比大多数主题持续时间更长，往往会贯穿整个 RC 阶段（约 2–3 个月）。

幸运的是，由于该主题只涉及以下两个软件包，因此不会与其他主题产生包冲突：

- `linux-kernel-rc`: 内核软件包本身。
- `linux+kernel+rc`: 内核元包，用于跟踪和辅助内核更新。

此类主题适用以下规则与流程：

- 每个内核分支对应一个主题（例如，5.9 一个主题，5.10 一个主题）。
- 在 RC 阶段结束时合并，并遵循上述的测试与通知流程。
    - RC 内核永远不会推送到 `stable` 仓库。
    - 合并后，将 linux-kernel-rc 转换为 linux-kernel，并将 linux+kernel+rc 转换为 linux+kernel，同时生成 Autobuild 清单。

## 新架构移植

当对新架构进行首次构建（即为新架构首次构建软件包）时，所有通用规则依然适用（在移植过程中，仍然一个包对应一个主题）。
不过，为了方便移植者与其他维护者，给予以下例外：

- 架构特定的主题无需推送到仓库，但仍需在每次构建时创建并合并主题分支，即使可以离线完成，也需保留记录。
- 受这些构建修复更改影响的其他架构，可以直接同步版本并将软件包直接推送到 `stable`.
    - 这是基于一个假设：这些更改不会影响软件包功能，仅影响版本/修订号的差异。

## 计划性重构

在进行计划性重构（主要用于刷新长期未更新的软件包）时，通常会一次性构建大量软件包。对此场景，给予以下例外：

- 在计划性重构主题中，可包含不限数量的软件包（只要在计划范围内）。
- 其他主题应为该主题让路，凡是包含受计划性重构影响软件包的其他主题，必须暂停，直至重构完成。

计划性重构主题的命名格式应为 `planned-rebuild-$DATE`，例如：
`planned-rebuild-20201225`。

# AOSC OS/Retro

主题化的流程与规则不适用于 AOSC OS/Retro.
该版本每年从 `stable` 分支同步一次更新，所有安全与漏洞修复直接提交到 `retro` 分支。

## 与主线版本的互操作性

每次从 stable 分支同步（或合并）后，需针对 `stable` 分支创建一个 Pull Request，并以 `retro-tracking-$YEAR` 作为主题名称。
其余流程与规则遵循前文所述内容。

# 文档

## 本次变更后需要修改的文档

随着迭代方式转变为基于主题的模式，以下文档需要进行修改：

- [软件包维护入门：进阶教程](/developer/packaging/advanced-techniques/)
    - 分支说明，`findupd-stable` 的使用已弃用。
- [软件包维护入门：基础教程](/developer/packaging/basics/)
    - 分支说明。
- [.NET 生命周期策略](/developer/packaging/dotnet/)
    - 分支说明。

## 本次变更废弃的文档

随着迭代方式转变为基于主题的模式，以下文档将被废弃：

- [AOSC OS 维护指南](/developer/packaging/maintenance-guidelines/)
- [更新周期例外](/developer/packaging/cycle-exceptions/)
- [已知补丁发布规则](/developer/packaging/known-patch-release-rules/)
